<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bản Đồ Lào Cai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5',
                        secondary: '#1e1b4b',
                        accent: '#10b981',
                        dark: '#0f172a',
                        light: {
                            bg: '#f8fafc',
                            sidebar: '#ffffff',
                            text: '#1e293b',
                            hover: '#e2e8f0'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'Calibri', 'sans-serif'],
                        display: ['Arial', 'sans-serif']
                    },
                    boxShadow: {
                        'soft': '0 4px 14px 0 rgba(0, 0, 0, 0.05)',
                        'soft-lg': '0 10px 28px rgba(0, 0, 0, 0.08)'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', 'Calibri', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            margin: 0;
            padding: 0;
        }
        
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .markdown p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
            color: #334155;
        }
        
        .markdown ul, .markdown ol {
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
        }
        
        .markdown li {
            margin-bottom: 0.5rem;
            color: #334155;
        }
        
        .markdown code:not(pre code) {
            background-color: #e2e8f0;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'Fira Code', monospace;
            color: #334155;
            font-size: 0.9em;
        }
        
        .markdown strong {
            font-weight: 600;
            color: #1e293b;
        }
        
        .markdown em {
            font-style: italic;
        }
        
        .markdown h1, .markdown h2, .markdown h3, .markdown h4 {
            font-weight: 600;
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
            color: #1e293b;
            font-family: 'Arial', sans-serif;
        }
        
        .markdown h1 {
            font-size: 1.5rem;
            line-height: 2rem;
        }
        
        .markdown h2 {
            font-size: 1.25rem;
            line-height: 1.75rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
        
        .markdown h3 {
            font-size: 1.125rem;
            line-height: 1.75rem;
        }
        
        .markdown h4 {
            font-size: 1rem;
            line-height: 1.5rem;
        }
        
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
        
        #map {
            height: 100%;
            width: 100%;
            z-index: 10;
        }

        .location-box {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .location-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .location-box h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #4f46e5;
            display: flex;
            align-items: center;
            font-family: 'Arial', sans-serif;
        }

        .location-box h3 i {
            margin-right: 0.5rem;
            color: #4f46e5;
        }
        
        .location-box h3 i.fa-star { 
            color: #f43f5e;
        }

        .location-box ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin: 0.5rem 0;
        }

        .location-box p, .location-box li {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #475569;
        }

        .search-input {
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            font-family: 'Inter', sans-serif;
        }

        .search-input:focus {
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        .sidebar-header {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .message-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Country highlight styles */
        .leaflet-tooltip {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            color: #000;
            font-weight: bold;
            text-shadow:
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                1px 1px 0 white;
            padding: 0 !important;
            font-family: 'Arial', sans-serif;
        }

        .country-highlight {
            animation: highlight 2s ease-in-out;
        }

        @keyframes highlight {
            0% { fill-opacity: 0.3; }
            50% { fill-opacity: 0.8; }
            100% { fill-opacity: 0.3; }
        }

        #result-container {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        
        #result-messages {
            display: flex;
            flex-direction: column;
        }

        .chat-input-container {
            position: sticky;
            bottom: 0;
            background-color: #ffffff;
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            z-index: 10;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            max-height: calc(100vh - 200px);
            margin-bottom: 0;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }
        
        /* Floating action buttons */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #4f46e5;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .fab:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
            background-color: #4338ca;
        }
        
        .fab-sidebar {
            position: fixed;
            bottom: 8rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #10b981;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .fab-sidebar:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
            background-color: #059669;
        }

        /* Gradient background */
        .gradient-bg {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Animated border */
        .animated-border {
            position: relative;
        }

        .animated-border::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #4f46e5, #10b981);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .animated-border:hover::after {
            transform: scaleX(1);
        }

        /* Pulse animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Location marker styles */
        .location-marker {
            background-color: #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            animation: pulse 1.5s infinite;
        }

        /* Key locations styles */
        .key-location {
            background-color: #10b981;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        }

        .key-location::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: rgba(16, 185, 129, 0.2);
            animation: ripple 2s infinite;
        }

        @keyframes ripple {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* Sidebar tabs */
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 1rem;
        }

        .sidebar-tab {
            flex: 1;
            text-align: center;
            padding: 0.75rem 0;
            cursor: pointer;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            font-family: 'Arial', sans-serif;
        }

        .sidebar-tab:hover {
            color: #4f46e5;
        }

        .sidebar-tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }

        /* Chat container */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            max-height: calc(100vh - 200px);
        }

        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        /* Timeline styles */
        .timeline-container {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .timeline-item {
            position: relative;
            padding-left: 2rem;
            margin-bottom: 1rem;
        }

        .timeline-item:last-child {
            margin-bottom: 0;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0.25rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background-color: #4f46e5;
            border: 2px solid #ffffff;
            z-index: 1;
        }

        .timeline-item::after {
            content: '';
            position: absolute;
            left: 1rem;
            top: 1.25rem;
            bottom: -1rem;
            width: 2px;
            background-color: #e2e8f0;
        }

        .timeline-item:last-child::after {
            display: none;
        }

        .timeline-content {
            background-color: #f8fafc;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border-left: 3px solid #4f46e5;
        }

        .timeline-time {
            font-weight: 600;
            color: #4f46e5;
            margin-bottom: 0.25rem;
            font-family: 'Arial', sans-serif;
        }

        .timeline-text {
            color: #475569;
        }
        
        /* Sidebar toggle button */
        .sidebar-toggle {
            position: absolute;
            top: 1rem;
            right: -1.5rem;
            width: 3rem;
            height: 3rem;
            background-color: #4f46e5;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .sidebar-toggle:hover {
            background-color: #4338ca;
            transform: scale(1.1);
        }
        
        .sidebar-collapsed {
            transform: translateX(-100%);
            position: absolute;
            left: -100%;
            background-color: transparent;
            box-shadow: none;
            border-right: none;
        }
        
        .sidebar-collapsed .sidebar-toggle {
            right: -3rem;
        }

        /* App container */
        #app {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative; /* Quan trọng: Tạo ngữ cảnh cho z-index */
        }

        #sidebar {
            width: 384px; /* Giữ nguyên kích thước ban đầu */
            height: 100%; /* Chiếm toàn bộ chiều cao */
            background-color: #ffffff;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1); /* Đổ bóng sang phải */
            position: absolute; /* Nổi lên trên bản đồ */
            left: 0; /* Căn trái */
            top: 0; /* Căn trên */
            z-index: 20; /* Đảm bảo nằm trên bản đồ */
            transition: transform 0.3s ease; /* Hiệu ứng khi ẩn/hiện */
        }

        #map-container {
            flex: 1;
            height: 100%;
            margin-left: 0; /* Bỏ margin-left để bản đồ chiếm toàn bộ không gian */
            position: relative;
            z-index: 10; /* Nằm dưới thanh bên */
        }
        .ai-result-content {
    padding: 10px;
    background-color: #f9f9f9;
    border-radius: 4px;
}
.info-section { margin: 10px 0; }
.info-section span { font-weight: bold; }

/* NEW STYLES FOR MOBILE RESPONSIVENESS */
.mobile-search-header {
    display: none;
}

.search-close-btn {
    display: none;
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: #f1f5f9;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    cursor: pointer;
    z-index: 30;
    color: #64748b;
}

.search-close-btn:hover {
    background: #e2e8f0;
    color: #475569;
}

/* Mobile responsive styles */
@media (max-width: 768px) {
    #sidebar {
        width: 100%;
        z-index: 100;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    
    .sidebar-toggle {
        right: 1rem;
        top: 1rem;
        background-color: rgba(79, 70, 229, 0.9);
    }
    
    .mobile-search-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        background: white;
    }
    
    .search-close-btn {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .sidebar-header {
        padding-top: 0;
    }
    
    #search-form {
        position: relative;
        padding-right: 40px;
    }
    
    .search-input {
        padding-right: 50px;
        font-size: 16px; /* Prevents zoom on iOS */
    }
    
    #search-form button[type="submit"] {
        right: 45px;
    }
}

@media (max-width: 480px) {
    .sidebar-header h2 {
        font-size: 1.25rem;
    }
    
    .search-input {
        padding: 12px 50px 12px 40px;
    }
    
    .location-box {
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .location-box h3 {
        font-size: 0.9rem;
    }
    
    .location-box p, .location-box li {
        font-size: 0.85rem;
    }
}
    </style>
</head>
<body class="h-screen flex flex-col gradient-bg text-light-text transition-all">
    <div id="app">
        <div id="sidebar" class="flex flex-col h-full transition-all duration-300 relative">
            <div class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fas fa-chevron-left"></i>
            </div>
            
            <!-- Mobile search header with close button -->
            <div class="mobile-search-header">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-search mr-2 text-primary"></i>Tìm kiếm
                </h2>
                <button class="search-close-btn" onclick="toggleSearch()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6 sidebar-header">
                <h2 class="text-2xl font-bold text-gray-800 font-display flex items-center">
                    <i class="fas fa-map-marked-alt mr-3 text-primary"></i>
                    <span class="animated-border">Bản Đồ Lào Cai</span>
                </h2>
                
                <div class="sidebar-tabs mt-4">
                    <div id="map-tab" class="sidebar-tab active" onclick="switchTab('map')">
                        <i class="fas fa-map mr-2"></i>
                        <span>Bản đồ</span>
                    </div>
                </div>
                <form id="search-form" class="relative mt-3">
                    <div class="relative">
                        <input 
                            id="search-input" 
                            type="text" 
                            class="w-full p-4 rounded-xl border border-gray-300 bg-white search-input focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-gray-800 pl-12"
                            placeholder="Tìm kiếm địa điểm hoặc nhân vật..."
                        />

                        <button type="submit" class="absolute right-3 top-1/2 transform -translate-y-1/2 bg-primary text-white p-2 rounded-lg hover:bg-secondary transition-colors">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
            
            <div id="map-results" class="flex-1 overflow-y-auto hide-scrollbar p-6">
                <div id="result-messages" class="flex flex-col gap-5 w-full">
                    <div class="location-box">
                        <h3><i class="fas fa-info-circle"></i> Giới thiệu Lào Cai</h3>
                        <p>Lào Cai là tỉnh miền núi vùng cao biên giới phía Bắc Việt Nam, nổi tiếng với Sa Pa - thị trấn du lịch nghỉ dưỡng, đỉnh Fansipan - nóc nhà Đông Dương, và nền văn hóa đa dạng của các dân tộc thiểu số.</p>
                    </div>
                </div>
                <div id="typing-indicator" class="hidden mt-4 p-4 bg-blue-50 rounded-xl text-blue-700 text-sm flex items-center">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500 mr-3"></div>
                    <span>Đang tìm kiếm thông tin, vui lòng đợi...</span>
                </div>
                <div id="stop-button-container" class="hidden mt-4">
                    <button id="stop-response-btn" class="bg-red-500 hover:bg-red-600 text-white px-5 py-3 rounded-xl text-sm font-medium transition-colors flex items-center justify-center w-full">
                        <i class="fas fa-stop mr-2"></i> <span>Dừng tìm kiếm</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="map-container" class="flex-1 flex flex-col h-full overflow-hidden relative">
            <div id="map" class="flex-1"></div>
            <div class="absolute top-4 right-4 z-20 bg-white p-2 rounded-lg shadow-md flex items-center">
                <i class="fas fa-layer-group text-gray-600 mr-2"></i>
                <span class="text-sm font-medium text-gray-700">Bản đồ Lào Cai</span>
            </div>
            
            <!-- Mobile search toggle button -->
            <div id="mobile-search-toggle" class="fab-sidebar md:hidden" onclick="toggleSearch()">
                <i class="fas fa-search"></i>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const API_KEY = "AIzaSyAboqphb7mWDWooaewnu73IlLI4XFs7kTg"; // Thay bằng API key thực tế của bạn
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const resultMessages = document.getElementById('result-messages');
        const typingIndicator = document.getElementById('typing-indicator');
        const stopButtonContainer = document.getElementById('stop-button-container');
        const mapResults = document.getElementById('map-results');
        const sidebar = document.getElementById('sidebar');
        const mapContainer = document.getElementById('map-container');
        const mobileSearchToggle = document.getElementById('mobile-search-toggle');
        const mobileSearchHeader = document.querySelector('.mobile-search-header');

        let map;
        let abortController = null;
        let isSending = false;
        let isStopped = false;
        let markers = [];
        let currentQueries = [];
        let countryLayer = null;
        let selectedCountryLayer = null;
        let countryLayers = {};
        let keyLocations = [];

        // Địa điểm nổi tiếng tại Lào Cai
        const laoCaiLocations = {
            "Sa Pa": {
                lat: 22.3364,
                lng: 103.8436,
                name: "Thị trấn Sa Pa",
                description: "Thị trấn du lịch nổi tiếng với khí hậu mát mẻ, ruộng bậc thang và văn hóa các dân tộc thiểu số"
            },
            "Fansipan": {
                lat: 22.3075,
                lng: 103.7750,
                name: "Đỉnh Fansipan",
                description: "Ngọn núi cao nhất Đông Dương (3.147m), được mệnh danh là nóc nhà Đông Dương"
            },
            "Bắc Hà": {
                lat: 22.5333,
                lng: 104.2833,
                name: "Thị trấn Bắc Hà",
                description: "Nổi tiếng với chợ phiên Bắc Hà và văn hóa của người Mông, Dao"
            },
            "Cốc Lếu": {
                lat: 22.4833,
                lng: 103.9500,
                name: "Chợ Cốc Lếu",
                description: "Khu chợ biên giới sầm uất tại thành phố Lào Cai"
            },
            "Cầu Mây": {
                lat: 22.3386,
                lng: 103.8414,
                name: "Cầu Mây Sa Pa",
                description: "Cây cầu treo nổi tiếng bằng tre nứa bắc qua suối Mường Hoa"
            },
            "Bản Cát Cát": {
                lat: 22.3250,
                lng: 103.8083,
                name: "Bản Cát Cát",
                description: "Bản làng của người H'Mông với văn hóa truyền thống độc đáo"
            },
            "Bản Tả Phìn": {
                lat: 22.3833,
                lng: 103.7833,
                name: "Bản Tả Phìn",
                description: "Bản làng của người Dao Đỏ với nghề thổ cẩm truyền thống"
            },
            "Thác Bạc": {
                lat: 22.3500,
                lng: 103.8167,
                name: "Thác Bạc",
                description: "Thác nước hùng vĩ cao hơn 200m trên đường lên đỉnh Fansipan"
            },
            "Đèo Ô Quy Hồ": {
                lat: 22.4000,
                lng: 103.7500,
                name: "Đèo Ô Quy Hồ",
                description: "Một trong tứ đại đỉnh đèo của Việt Nam, nối Lào Cai với Lai Châu"
            },
            "Núi Hàm Rồng": {
                lat: 22.3361,
                lng: 103.8469,
                name: "Núi Hàm Rồng",
                description: "Địa điểm ngắm toàn cảnh Sa Pa và thung lũng Mường Hoa"
            },
            "Cổng Trời": {
                lat: 22.3167,
                lng: 103.8000,
                name: "Cổng Trời",
                description: "Địa điểm ngắm cảnh tuyệt đẹp trên đường lên đỉnh Fansipan"
            },
            "Suối Vàng": {
                lat: 22.3333,
                lng: 103.8333,
                name: "Thung lũng Mường Hoa - Suối Vàng",
                description: "Thung lũng với dòng suối uốn lượn và những bãi đá cổ có khắc hình bí ẩn"
            }
        };

        // Nhân vật liên quan đến Lào Cai
        const laoCaiFigures = {
            "Hoàng A Tưởng": {
                lat: 22.5333,
                lng: 104.2833,
                name: "Vua Mèo Hoàng A Tưởng",
                description: "Thổ ty người Mông nổi tiếng ở Bắc Hà đầu thế kỷ 20",
                time: "Đầu thế kỷ 20",
                achievements: ["Xây dựng dinh thự Hoàng A Tưởng", "Phát triển vùng Bắc Hà"],
                significance: "Biểu tượng quyền lực của người Mông ở vùng cao Lào Cai"
            },
            "Cố Lý": {
                lat: 22.3364,
                lng: 103.8436,
                name: "Các nghệ nhân dân tộc",
                description: "Những người giữ gìn và phát triển văn hóa truyền thống các dân tộc Lào Cai",
                time: "Truyền thống lâu đời",
                achievements: ["Bảo tồn nghề dệt thổ cẩm", "Gìn giữ văn hóa dân tộc"],
                significance: "Góp phần bảo tồn và phát triển văn hóa các dân tộc thiểu số Lào Cai"
            }
        };

        function isFigureQuery(query) {
            const lowerQuery = query.toLowerCase();
            const figureKeywords = [
                "nhân vật", "người nổi tiếng", "danh nhân", "anh hùng", "nghệ sĩ", 
                "hoàng a tưởng", "vua mèo", "nghệ nhân", "cố lý",
                "figure", "famous person", "celebrity", "hero", "artist"
            ];
            return figureKeywords.some(keyword => lowerQuery.includes(keyword)) || 
                   Object.keys(laoCaiFigures).some(figure => 
                       lowerQuery.includes(figure.toLowerCase())
                   );
        }

        function focusSearchInput() {
            searchInput.focus();
        }

        function isLocationQuery(query) {
            return true; // Bỏ qua kiểm tra từ khóa lịch sử
        }

        function isLandmarkQuery(query) {
            const lowerQuery = query.toLowerCase();
            const landmarkKeywords = [
                "bản", "làng", "thác", "núi", "đèo", "suối", "chợ", "cầu", "thị trấn", "đỉnh",
                "village", "waterfall", "mountain", "pass", "stream", "market", "bridge", "town", "peak",
                "sa pa", "fansipan", "bắc hà", "cốc lếu", "cát cát", "tả phìn", "thác bạc", "ô quy hồ", "hàm rồng"
            ];
            return landmarkKeywords.some(keyword => lowerQuery.includes(keyword)) || 
                   Object.keys(laoCaiLocations).some(loc => 
                       lowerQuery.includes(loc.toLowerCase())
                   );
        }

        function initApp() {
            initMap();
            setupEventListeners();
            addLaoCaiMarkers();
            checkMobileView();
        }

        function initMap() {
            // Thiết lập giới hạn bản đồ cho khu vực Lào Cai và vùng phụ cận
            const southWest = L.latLng(21.8, 103.5);
            const northEast = L.latLng(22.8, 104.5);
            const bounds = L.latLngBounds(southWest, northEast);
            
            // Khởi tạo bản đồ với tâm là trung tâm Lào Cai
            map = L.map('map', {
                center: [22.4833, 103.9500],
                zoom: 10,
                maxBounds: bounds,
                maxBoundsViscosity: 0.8,
                minZoom: 9,
                maxZoom: 16
            }).setView([22.4833, 103.9500], 10);
            
            // Thiết lập tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                noWrap: true
            }).addTo(map);

            // Vô hiệu hóa kéo bản đồ ra ngoài khu vực cho phép
            map.setMaxBounds(bounds);
        }

        function addLaoCaiMarkers() {
            // Xóa các marker cũ nếu có
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Thêm marker cho các địa điểm nổi tiếng
            for (const [key, location] of Object.entries(laoCaiLocations)) {
                const marker = L.marker([location.lat, location.lng], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: `<div class="location-marker">
                                  <i class="fas fa-map-marker-alt"></i>
                              </div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    })
                }).addTo(map)
                    .bindPopup(`
                        <div class="font-medium text-primary">${location.name}</div>
                        <div class="text-sm mt-1">${location.description}</div>
                    `);
                
                markers.push(marker);
            }
        }

        function setupEventListeners() {
            searchForm.addEventListener('submit', handleSubmit);
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (searchInput.value.trim() !== '') {
                        searchForm.dispatchEvent(new Event('submit'));
                    }
                }
            });

            document.getElementById('stop-response-btn').addEventListener('click', () => {
                isStopped = true;
                stopButtonContainer.classList.add('hidden');
                typingIndicator.classList.add('hidden');
                
                if (abortController) {
                    abortController.abort();
                }
            });

            // Thêm sự kiện resize để xử lý responsive
            window.addEventListener('resize', checkMobileView);
        }

        // Kiểm tra xem có đang ở chế độ mobile không
        function checkMobileView() {
            if (window.innerWidth <= 768) {
                // Ẩn sidebar mặc định trên mobile
                sidebar.classList.add('sidebar-collapsed');
                document.querySelector('.sidebar-toggle i').classList.remove('fa-chevron-left');
                document.querySelector('.sidebar-toggle i').classList.add('fa-chevron-right');
                mobileSearchToggle.classList.remove('hidden');
            } else {
                // Hiển thị sidebar trên desktop/tablet
                sidebar.classList.remove('sidebar-collapsed');
                document.querySelector('.sidebar-toggle i').classList.remove('fa-chevron-right');
                document.querySelector('.sidebar-toggle i').classList.add('fa-chevron-left');
                mobileSearchToggle.classList.add('hidden');
            }
        }

        // Hàm mới: bật/tắt chế độ tìm kiếm trên mobile
        function toggleSearch() {
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('sidebar-collapsed');
                if (!sidebar.classList.contains('sidebar-collapsed')) {
                    // Nếu sidebar đang hiển thị, focus vào ô tìm kiếm
                    setTimeout(() => {
                        searchInput.focus();
                    }, 300);
                }
            }
        }

        async function handleSubmit(e) {
            if (e) e.preventDefault();
            
            const userQuery = searchInput.value.trim();
            if (!userQuery || isSending) return;

            isSending = true;
            isStopped = false;
            clearPreviousData();
            addMessageToUI("user", userQuery);

            currentQueries.push({ 
                role: "user", 
                content: userQuery,
                timestamp: new Date().toISOString()
            });

            searchInput.value = "";
            typingIndicator.classList.remove("hidden");
            stopButtonContainer.classList.remove("hidden"); 

            abortController = new AbortController();

            try {
                let prompt = userQuery;
                let responseType = "general";

                if (isLandmarkQuery(userQuery)) {
                    responseType = "landmark";
                    prompt = `
                        Cung cấp thông tin chi tiết về địa điểm "${userQuery}" tại Lào Cai bằng tiếng Việt theo định dạng JSON hợp lệ. JSON phải có các trường sau:
                        {
                            "name": "Tên địa điểm",
                            "location": "Vị trí cụ thể (ví dụ: 'Huyện Sa Pa, Lào Cai')",
                            "lat": "Tọa độ vĩ độ của địa điểm",
                            "lng": "Tọa độ kinh độ của địa điểm",
                            "type": "Loại địa điểm (du lịch, văn hóa, thiên nhiên, lịch sử, v.v.)",
                            "description": "Mô tả chi tiết về địa điểm",
                            "features": ["Danh sách các đặc điểm nổi bật"],
                            "activities": ["Các hoạt động có thể làm tại đây"],
                            "best_time": "Thời gian tốt nhất để ghé thăm",
                            "transportation": "Phương tiện di chuyển đến đây"
                        }
                    `;
                } else if (isFigureQuery(userQuery)) {
                    responseType = "figure";
                    prompt = `
                        Cung cấp thông tin về nhân vật "${userQuery}" liên quan đến Lào Cai bằng tiếng Việt theo định dạng JSON hợp lệ. JSON phải có các trường sau:
                        {
                            "name": "Tên nhân vật",
                            "location": "Địa điểm liên quan tại Lào Cai",
                            "lat": "Tọa độ vĩ độ của địa điểm",
                            "lng": "Tọa độ kinh độ của địa điểm",
                            "time": "Thời gian hoạt động (không đề cập triều đại)",
                            "description": "Mô tả về nhân vật",
                            "achievements": ["Danh sách thành tựu nổi bật"],
                            "significance": "Ý nghĩa và đóng góp cho Lào Cai"
                        }
                        LƯU Ý: KHÔNG đề cập đến các trận chiến, chiến tranh hay xung đột quân sự.
                    `;
                } else {
                    prompt = `Cung cấp thông tin về "${userQuery}" tại Lào Cai bằng tiếng Việt. Nếu là địa điểm hoặc nhân vật, hãy cung cấp thông tin chi tiết.`;
                }

                const chatSession = model.startChat({
                    history: currentQueries.map(query => ({
                        role: query.role === "user" ? "user" : "model",
                        parts: [{ text: query.content }]
                    })),
                    generationConfig: {
                        maxOutputTokens: 2000,
                        temperature: 0.7,
                        topP: 0.1,
                        topK: 16,
                    }
                });

                if (isStopped) {
                    throw new Error("Search stopped by user");
                }

                const result = await chatSession.sendMessage(prompt, { signal: abortController.signal });
                
                if (isStopped) {
                    throw new Error("Search stopped by user");
                }

                const response = await result.response;
                let botReply = response.text();

                console.log("Phản hồi từ Gemini (handleSubmit):", botReply);

                if (responseType === "landmark") {
                    try {
                        let jsonStr = botReply;
                        if (jsonStr.includes('```json')) {
                            jsonStr = jsonStr.split('```json')[1].split('```')[0].trim();
                        } else if (jsonStr.includes('```')) {
                            jsonStr = jsonStr.split('```')[1].split('```')[0].trim();
                        }

                        let locationData;
                        try {
                            locationData = JSON.parse(jsonStr);
                        } catch (e) {
                            jsonStr = jsonStr.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2":');
                            locationData = JSON.parse(jsonStr);
                        }

                        botReply = formatLocationData(locationData);

                        if (locationData.location) {
                            console.log("Đang lấy vị trí cho:", locationData.location);
                            if (locationData.lat && locationData.lng) {
                                addMarker(locationData.lat, locationData.lng, locationData.name || userQuery);
                                map.setView([locationData.lat, locationData.lng], 14);
                                botReply += `\n\n**Địa điểm**: ${locationData.location}`;
                                botReply += `\n\n**Vĩ độ**: ${locationData.lat}, **Kinh độ**: ${locationData.lng}`;
                            } else {
                                const location = await getLocationCoordinates(locationData.location);
                                if (location && location.lat && location.lng) {
                                    addMarker(location.lat, location.lng, locationData.name || userQuery);
                                    botReply += `\n\n**Địa điểm**: ${location.description || location.name}`;
                                    botReply += `\n\n**Vĩ độ**: ${location.lat}, **Kinh độ**: ${location.lng}`;
                                    map.setView([location.lat, location.lng], 14);
                                } else {
                                    console.warn("Không có dữ liệu vị trí hợp lệ cho:", locationData.location, "Truy vấn:", userQuery);
                                    botReply += `\n\n**Địa điểm**: ${locationData.location} (Không xác định)`;
                                }
                            }
                        } else {
                            console.warn("Không có vị trí được cung cấp trong locationData cho truy vấn:", userQuery);
                            botReply += `\n\n**Địa điểm**: Không xác định`;
                        }

                        if (!isStopped) {
                            addMessageToUI("assistant", botReply);
                            currentQueries.push({ 
                                role: "assistant", 
                                content: botReply,
                                timestamp: new Date().toISOString()
                            });
                        }
                    } catch (e) {
                        console.error("Lỗi phân tích JSON (địa điểm):", e, "Phản hồi:", botReply);
                        botReply = `Thông tin về địa điểm:\n\n${botReply}`;
                        addMessageToUI("assistant", botReply);
                        currentQueries.push({ 
                            role: "assistant", 
                            content: botReply,
                            timestamp: new Date().toISOString()
                        });
                    }
                } else if (responseType === "figure") {
                    try {
                        let jsonStr = botReply;
                        if (jsonStr.includes('```json')) {
                            jsonStr = jsonStr.split('```json')[1].split('```')[0].trim();
                        } else if (jsonStr.includes('```')) {
                            jsonStr = jsonStr.split('```')[1].split('```')[0].trim();
                        }

                        let figureData;
                        try {
                            figureData = JSON.parse(jsonStr);
                        } catch (e) {
                            jsonStr = jsonStr.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2":');
                            figureData = JSON.parse(jsonStr);
                        }

                        botReply = formatFigureData(figureData);

                        if (figureData.location) {
                            console.log("Đang lấy vị trí cho:", figureData.location);
                            if (figureData.lat && figureData.lng) {
                                addMarker(figureData.lat, figureData.lng, figureData.name || userQuery);
                                map.setView([figureData.lat, figureData.lng], 14);
                                botReply += `\n\n**Địa điểm liên quan**: ${figureData.location}`;
                                botReply += `\n\n**Vĩ độ**: ${figureData.lat}, **Kinh độ**: ${figureData.lng}`;
                            } else {
                                const location = await getLocationCoordinates(figureData.location);
                                if (location && location.lat && location.lng) {
                                    addMarker(location.lat, location.lng, figureData.name || userQuery);
                                    botReply += `\n\n**Địa điểm liên quan**: ${location.description || location.name}`;
                                    botReply += `\n\n**Vĩ độ**: ${location.lat}, **Kinh độ**: ${location.lng}`;
                                    map.setView([location.lat, location.lng], 14);
                                } else {
                                    console.warn("Không có dữ liệu vị trí hợp lệ cho:", figureData.location, "Truy vấn:", userQuery);
                                    botReply += `\n\n**Địa điểm liên quan**: ${figureData.location} (Không xác định)`;
                                }
                            }
                        } else {
                            console.warn("Không có vị trí được cung cấp trong figureData cho truy vấn:", userQuery);
                            botReply += `\n\n**Địa điểm liên quan**: Không xác định`;
                        }

                        if (!isStopped) {
                            addMessageToUI("assistant", botReply);
                            currentQueries.push({ 
                                role: "assistant", 
                                content: botReply,
                                timestamp: new Date().toISOString()
                            });
                        }
                    } catch (e) {
                        console.error("Lỗi phân tích JSON (nhân vật):", e, "Phản hồi:", botReply);
                        botReply = `Thông tin về nhân vật:\n\n${botReply}`;
                        addMessageToUI("assistant", botReply);
                        currentQueries.push({ 
                            role: "assistant", 
                            content: botReply,
                            timestamp: new Date().toISOString()
                        });
                    }
                } else {
                    if (!isStopped) {
                        addMessageToUI("assistant", botReply);
                        currentQueries.push({ 
                            role: "assistant", 
                            content: botReply,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError' || error.message === "Search stopped by user") {
                    console.log("Tìm kiếm đã bị dừng bởi người dùng");
                    addMessageToUI("assistant", "Tìm kiếm đã dừng theo yêu cầu của bạn.");
                } else {
                    console.error("Lỗi trong handleSubmit:", error);
                    addMessageToUI("assistant", "Lỗi khi xử lý yêu cầu. Vui lòng thử lại!");
                }
            } finally {
                isSending = false;
                typingIndicator.classList.add("hidden");
                stopButtonContainer.classList.add("hidden");
                abortController = null;
                scrollToTop();
            }
        }

        function transliterateVietnamese(text) {
            const map = {
                'à': 'a', 'á': 'a', 'ả': 'a', 'ã': 'a', 'ạ': 'a',
                'è': 'e', 'é': 'e', 'ẻ': 'e', 'ẽ': 'e', 'ẹ': 'e',
                'ì': 'i', 'í': 'i', 'ỉ': 'i', 'ĩ': 'i', 'ị': 'i',
                'ò': 'o', 'ó': 'o', 'ỏ': 'o', 'õ': 'o', 'ọ': 'o',
                'ù': 'u', 'ú': 'u', 'ủ': 'u', 'ũ': 'u', 'ụ': 'u',
                'ỳ': 'y', 'ý': 'y', 'ỷ': 'y', 'ỹ': 'y', 'ỵ': 'y',
                'đ': 'd', 'â': 'a', 'ê': 'e', 'ô': 'o', 'ơ': 'o', 'ư': 'u'
            };
            return text.replace(/[àáảãạèéẻẽẹìíỉĩịòóỏõọùúủũụỳýỷỹỵđâêôơư]/g, match => map[match] || match)
                       .replace(/\s+/g, ' ')
                       .trim();
        }

        async function getLocationCoordinates(locationName) {
            try {
                if (!locationName) return null;

                const normalizedLocation = locationName.trim().toLowerCase();
                const transliteratedLocation = transliterateVietnamese(normalizedLocation);

                // Kiểm tra xem địa điểm có trong danh sách Lào Cai không
                for (const [key, value] of Object.entries(laoCaiLocations)) {
                    const keyNormalized = key.toLowerCase();
                    const nameNormalized = value.name ? value.name.toLowerCase() : '';

                    if (normalizedLocation.includes(keyNormalized) || 
                        (nameNormalized && normalizedLocation.includes(nameNormalized)) ||
                        (nameNormalized && transliteratedLocation.includes(nameNormalized))) {
                        return {
                            lat: value.lat,
                            lng: value.lng,
                            name: value.name,
                            description: value.description
                        };
                    }
                }

                // Kiểm tra xem địa điểm có trong danh sách nhân vật Lào Cai không
                for (const [key, value] of Object.entries(laoCaiFigures)) {
                    const keyNormalized = key.toLowerCase();
                    const nameNormalized = value.name ? value.name.toLowerCase() : '';

                    if (normalizedLocation.includes(keyNormalized) || 
                        (nameNormalized && normalizedLocation.includes(nameNormalized)) ||
                        (nameNormalized && transliteratedLocation.includes(nameNormalized))) {
                        return {
                            lat: value.lat,
                            lng: value.lng,
                            name: value.name,
                            description: value.description
                        };
                    }
                }

                // Nếu không tìm thấy trong danh sách, thử tìm với OpenStreetMap
                let query = encodeURIComponent(`${locationName}, Lào Cai`);
                let data;
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1&accept-language=vi`);
                    if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                    data = await response.json();
                } catch (error) {
                    console.error(`Lỗi gọi Nominatim cho "${locationName}":`, error);
                }

                if (data && data.length > 0) {
                    const result = data[0];
                    return {
                        lat: parseFloat(result.lat),
                        lng: parseFloat(result.lon),
                        name: result.display_name.split(',')[0],
                        description: null
                    };
                }

                console.warn(`Không tìm thấy tọa độ cho địa điểm: "${locationName}"`);
                return null;
            } catch (error) {
                console.error(`Lỗi khi lấy tọa độ cho "${locationName}":`, error);
                return null;
            }
        }

        function addMarker(lat, lng, title) {
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div class="location-marker">
                              <i class="fas fa-map-marker-alt"></i>
                          </div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                })
            }).addTo(map)
                .bindPopup(`<div class="font-medium text-primary">${title}</div>`)
                .openPopup();
            markers.push(marker);
        }

        function formatLocationData(data) {
            return `
<div class="location-container">
    <div class="location-box">
        <h3><i class="fas fa-landmark"></i> Tên địa điểm</h3>
        <p>${data.name || 'Không xác định'}</p>
    </div>
    <div class="location-box">
        <h3><i class="fas fa-map-marker-alt"></i> Vị trí</h3>
        <p>${data.location || 'Không xác định'}</p>
    </div>
    <div class="location-box">
        <h3><i class="fas fa-tag"></i> Loại địa điểm</h3>
        <p>${data.type || 'Không xác định'}</p>
    </div>
    <div class="location-box">
        <h3><i class="fas fa-align-left"></i> Mô tả</h3>
        <p>${data.description || 'Không có mô tả'}</p>
    </div>
    ${data.features && data.features.length > 0 ? `
    <div class="location-box">
        <h3><i class="fas fa-star"></i> Đặc điểm nổi bật</h3>
        <ul>${data.features.map(feature => `<li>${feature}</li>`).join("")}</ul>
    </div>
    ` : ''}
    ${data.activities && data.activities.length > 0 ? `
    <div class="location-box">
        <h3><i class="fas fa-running"></i> Hoạt động</h3>
        <ul>${data.activities.map(activity => `<li>${activity}</li>`).join("")}</ul>
    </div>
    ` : ''}
    ${data.best_time ? `
    <div class="location-box">
        <h3><i class="fas fa-calendar-alt"></i> Thời gian tốt nhất</h3>
        <p>${data.best_time}</p>
    </div>
    ` : ''}
    ${data.transportation ? `
    <div class="location-box">
        <h3><i class="fas fa-bus"></i> Phương tiện di chuyển</h3>
        <p>${data.transportation}</p>
    </div>
    ` : ''}
</div>
    `;
        }

        function formatFigureData(data) {
            return `
<div class="figure-container">
    <div class="location-box">
        <h3><i class="fas fa-user"></i> Tên nhân vật</h3>
        <p>${data.name || 'Không xác định'}</p>
    </div>
    <div class="location-box">
        <h3><i class="fas fa-clock"></i> Thời gian hoạt động</h3>
        <p>${data.time || 'Không xác định'}</p>
    </div>
    <div class="location-box">
        <h3><i class="fas fa-map-marker-alt"></i> Địa điểm liên quan</h3>
        <p>${data.location || 'Không xác định'}</p>
    </div>
    <div class="location-box">
        <h3><i class="fas fa-align-left"></i> Mô tả</h3>
        <p>${data.description || 'Không có mô tả'}</p>
    </div>
    ${data.achievements && data.achievements.length > 0 ? `
    <div class="location-box">
        <h3><i class="fas fa-trophy"></i> Thành tựu nổi bật</h3>
        <ul>${data.achievements.map(achievement => `<li>${achievement}</li>`).join("")}</ul>
    </div>
    ` : ''}
    ${data.significance ? `
    <div class="location-box">
        <h3><i class="fas fa-star"></i> Ý nghĩa với Lào Cai</h3>
        <p>${data.significance}</p>
    </div>
    ` : ''}
</div>
    `;
        }

        function addMessageToUI(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-4 ${role === 'user' ? 'text-right' : 'text-left'}`;
            
            const bubbleClass = role === 'user' 
                ? 'bg-primary text-white rounded-tr-none' 
                : 'bg-white text-gray-800 rounded-tl-none shadow-sm border border-gray-200';
            
            let translatedContent = content;
            if (content.includes("Xin lỗi, tôi chỉ trả lời các câu hỏi liên quan đến lịch sử")) {
                translatedContent = "Xin lỗi, tôi chỉ trả lời các câu hỏi liên quan đến Lào Cai. Vui lòng nhập một truy vấn về địa điểm tại Lào Cai!";
            } else if (content.includes("Lỗi tải dữliệu bản đồ")) {
                translatedContent = "Lỗi tải dữ liệu bản đồ, vui lòng thử lại sau.";
            } else if (content.includes("Lỗi khi xử lý yêu cầu")) {
                translatedContent = "Lỗi khi xử lý yêu cầu. Vui lòng thử lại!";
            } else {
                translatedContent = formatMessage(content);
            }

            messageDiv.innerHTML = `
                <div class="inline-block max-w-[85%] rounded-xl p-4 ${bubbleClass} relative">
                    <div class="message-content">${translatedContent}</div>
                    ${role === 'assistant' ? `
                    <span class="close-btn absolute top-2 right-2 cursor-pointer text-gray-500 hover:text-gray-700" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </span>
                    ` : ''}
                </div>
                ${role === 'assistant' ? `
                <div class="mt-1 text-xs text-gray-500 flex items-center">
                    <i class="fas fa-robot mr-1"></i>
                    <span>Hệ thống Lào Cai</span>
                </div>
                ` : ''}
            `;
            
            resultMessages.appendChild(messageDiv);
            scrollToTop();
        }

        function formatMessage(content) {
            if (!content) return '';

            let formatted = content.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            formatted = formatted.replace(/`([^`]+)`/g, '<code class="bg-gray-800 px-1 py-0.5 rounded text-white">$1</code>');

            formatted = formatted.split('\n\n').map(paragraph => {
                if (paragraph.trim().startsWith('<') && paragraph.trim().endsWith('>')) {
                    return paragraph;
                }
                return `<p>${paragraph}</p>`;
            }).join('');

            formatted = formatted.replace(/\n(?![<])/g, '<br>');

            return formatted;
        }

        function scrollToTop() {
            setTimeout(() => {
                document.getElementById('result-container').scrollTop = 0;
            }, 100);
        }

        function switchTab(tab) {
            if (tab === 'map') {
                document.getElementById('map-tab').classList.add('active');
                mapResults.classList.remove('hidden');
                document.getElementById('search-form').classList.remove('hidden');
            }
        }

        function toggleSidebar() {
            sidebar.classList.toggle('sidebar-collapsed');
            const toggleIcon = document.querySelector('.sidebar-toggle i');
            if (sidebar.classList.contains('sidebar-collapsed')) {
                toggleIcon.classList.remove('fa-chevron-left');
                toggleIcon.classList.add('fa-chevron-right');
                mapContainer.style.marginLeft = '0';
            } else {
                toggleIcon.classList.remove('fa-chevron-right');
                toggleIcon.classList.add('fa-chevron-left');
                mapContainer.style.marginLeft = '0';
            }
        }

        function clearPreviousData() {
            resultMessages.innerHTML = '';
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            keyLocations.forEach(loc => map.removeLayer(loc));
            keyLocations = [];
        }

        document.addEventListener('DOMContentLoaded', initApp);
        window.switchTab = switchTab;
        window.focusSearchInput = focusSearchInput;
        window.toggleSidebar = toggleSidebar;
        window.toggleSearch = toggleSearch;
    </script>
</body>
</html>
